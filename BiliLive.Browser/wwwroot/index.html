<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <title>MapWorkShop.Browser</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./app.css" />
    <style>
        #progress-container {
            width: 100%;
            height: 4px;
            background: #ccc;
            position: fixed;
            top: 0;
            left: 0;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: #4caf50;
            transition: width 0.2s;
        }

        #loading-text {
            position: fixed;
            top: 10px;
            right: 10px;
            color: #333;
            font-size: 14px;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden">
<div id="out">
    <div class="avalonia-splash">
        <h2>Powered by PVP_GOOD_</h2>
    </div>
</div>

<div id="progress-container">
    <div id="progress-bar"></div>
</div>
<div id="loading-text">Loading...</div>

<script type="module">
    import { dotnet } from './_framework/dotnet.js';

    const bar = document.getElementById("progress-bar");
    const text = document.getElementById("loading-text");

    let loadedBytes = 0;
    let totalBytes = 0;

    const dotnetRuntime = await dotnet
        .withDiagnosticTracing(false)
        .withApplicationArgumentsFromQuery()
        .withResourceLoader((type, name, defaultUri, integrity) => {
            // ⬅️ dotnetjs 必须直接返回 URL，不要 fetch
            if (type === "dotnetjs") {
                return defaultUri;
            }

            // ⬅️ 其他资源（dll/wasm/pdb等）才 fetch，用来统计进度
            return fetch(defaultUri, { integrity }).then(resp => {
                const contentLength = resp.headers.get("Content-Length");
                if (contentLength) {
                    totalBytes += parseInt(contentLength);
                }
                const reader = resp.body.getReader();

                return new Response(
                    new ReadableStream({
                        async pull(controller) {
                            const { done, value } = await reader.read();
                            if (done) {
                                controller.close();
                                return;
                            }
                            loadedBytes += value.length;
                            const percent = totalBytes ? (loadedBytes / totalBytes) * 100 : 0;
                            bar.style.width = percent + "%";
                            text.textContent = `Loading... ${percent.toFixed(1)}%`;
                            controller.enqueue(value);
                        }
                    })
                );
            });
        })
        .create();

    const config = dotnetRuntime.getConfig();
    await dotnetRuntime.runMain(config.mainAssemblyName, [globalThis.location.href]);

    // 运行完成后移除进度条
    document.getElementById("progress-container").style.display = "none";
    text.style.display = "none";
</script>
</body>

</html>
